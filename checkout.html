function doPost(e) {
  var sheet = SpreadsheetApp.getActiveSheet();
  var data = {};

  // Log the raw event for debugging
  Logger.log("Raw Event: " + JSON.stringify(e));

  // Check if e is defined and has postData
  if (e && e.postData && e.postData.contents) {
    try {
      data = JSON.parse(e.postData.contents);
      Logger.log("Received Raw Data: " + e.postData.contents);
    } catch (parseError) {
      Logger.log("Parse Error: " + parseError.message);
      data = { error: "Failed to parse data" };
    }
  } else {
    Logger.log("No valid postData received. Event:", JSON.stringify(e));
    data = { error: "No valid data received" };
  }

  Logger.log("Parsed Data: " + JSON.stringify(data));

  // Handle order creation or data logging based on action
  if (data.action === 'createOrder' && data.amount) {
    return createRazorpayOrder(data.amount);
  } else if (data && data.payment_id) {
    sheet.appendRow([new Date(), data.order_id || "N/A", data.payment_id, data.amount || 0, data.name || "Unknown", data.phone || "N/A"]);
    return ContentService.createTextOutput(JSON.stringify({ result: 'success' }))
      .setMimeType(ContentService.MimeType.JSON);
  } else {
    return ContentService.createTextOutput(JSON.stringify({ result: 'error', message: 'Invalid or no data' }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function createRazorpayOrder(amount) {
  var razorpayKey = 'rzp_test_maU4XuBdHu3f6b'; // Replace with your Razorpay Key ID
  var razorpaySecret = 'OFAmfrqd2cb8vmyPtUID3uAO'; // Replace with your Razorpay Secret Key (keep secure)
  var url = 'https://api.razorpay.com/v1/orders';
  var payload = {
    amount: amount * 100, // Amount in paise
    currency: 'INR',
    receipt: 'order_rcptid_' + new Date().getTime(),
    notes: {
      purpose: 'Sea Food Kings Order'
    }
  };

  var options = {
    method: 'post',
    contentType: 'application/json',
    headers: {
      Authorization: 'Basic ' + Utilities.base64Encode(razorpayKey + ':' + razorpaySecret)
    },
    payload: JSON.stringify(payload)
  };

  try {
    var response = UrlFetchApp.fetch(url, options);
    var result = JSON.parse(response.getContentText());
    Logger.log("Order Creation Response: " + JSON.stringify(result));
    if (result.id) {
      return ContentService.createTextOutput(JSON.stringify({ order_id: result.id }))
        .setMimeType(ContentService.MimeType.JSON);
    } else {
      throw new Error('Order creation failed: ' + JSON.stringify(result));
    }
  } catch (error) {
    Logger.log("Order Creation Error: " + error.message);
    return ContentService.createTextOutput(JSON.stringify({ error: error.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// Optional: Add doGet for testing
function doGet(e) {
  return HtmlService.createHtmlOutput("Test endpoint working");
}
